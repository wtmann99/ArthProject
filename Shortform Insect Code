setwd("C:/Users/wtmann/Documents/WillMfiles/Koerner Lab/Koerner Lab/R Studio files/Grad Research") #Or whatever the local branch is
library(tidyverse)


Herb20<-read.csv("Entered Sandhills Leaf Damage Data_2020.csv", na.strings = "") %>%
  mutate(Year="20")

Herb20Stretch<- Herb20 %>%
  select(-Notes)%>%
  drop_na(Plot) %>%
  group_by(Block, Plot, Treatment, Replicate, Species) %>%
  gather(HerbType, HerbPerc,6:11)%>%
  ungroup() %>%
  drop_na(HerbPerc) %>%
  select(Block, Plot, Treatment, Replicate, Species, HerbType, HerbPerc, Year) %>%
  filter(Species!="Chrysopsis_mariana")%>%
  filter(Species!="Lespedeza_hirta") %>%
  filter(HerbType==c("Chew","Mine.Suck"))


Herb21<-read.csv("Entered Sandhills Leaf Damage Data_2021.csv", na.strings = "") %>%
  mutate(Year="21")

Herb21Stretch<- Herb21 %>%
  select(-Notes)%>%
  drop_na(Plot) %>%
  group_by(Block, Plot, Treatment, Rep, Species) %>%
  gather(HerbType, HerbPerc,6:11)%>%
  ungroup() %>%
  drop_na(HerbPerc) %>%
  filter(HerbType==c("Chew","Mine.Suck")) %>%
  rename(Replicate=Rep)


PeakHerb22<-read.csv("Mann_Leaf_Damage_2022.csv", na.strings = "") %>%
  filter(Timepoint=="2") %>%
  mutate(Year="22")

Peak22Stretch<- PeakHerb22 %>%
  select(-Notes, -Date, -Damage.Assesser.s., -Scribe)%>%
  drop_na(Plot) %>%
  group_by(Block, Plot, Treatment, Replicate, Species) %>%
  gather(HerbType, HerbPerc,6:11)%>%
  ungroup() %>%
  drop_na(HerbPerc) %>%
  filter(HerbType==c("Chew","Mine.Suck")) %>%
  select(-Timepoint)

Peak22Stretch <- Peak22Stretch %>%  
  mutate(HerbPerc = as.numeric(HerbPerc))


HComp2020_21<- full_join(Herb20Stretch, Herb21Stretch)

HCompall<-full_join(HComp2020_21, Peak22Stretch) %>%
  filter(HerbType==c("Chew","Mine.Suck")) %>%
  group_by(Block, Plot, Treatment, Species, HerbType, Year) %>%
  ungroup() %>%
  filter(Species!="Chrysopsis_mariana")%>%
  filter(Species!="Lespedeza_hirta") %>%
  filter(Species!="Dichanthelium_commutatum") %>%
  mutate(Treatment_Year=paste(Treatment, Year, sep="_"))


Converted<-read.csv("ConvertedTreat.csv")

TrueHerb<-left_join(HCompall, Converted, by="Plot") %>%
  select(-Treatment.y) %>%
  rename(Treatment=Treatment.x) %>%
  summarise(Block, Plot, Species, Treatment_Year, HerbType, HerbPerc, Year, Nitrogen, Phosphorous, Potassium, Drought) %>%
  group_by(Plot, Species, Treatment_Year) %>%
  ungroup()

HerbDam<-HCompall %>%
  # summarise(Plot, Species, Treatment_Year, HerbType, avgherb, Year, Treatment) %>%
  group_by(Block, Plot, Species, Year, Treatment, Treatment_Year) %>%
  summarize(totaldam= sum(HerbPerc))%>%
  ungroup() %>%
  select(Block, Plot, Species,Year, Treatment,totaldam)


#### True Damage ####
TrueDamage<-left_join(HerbDam, Converted, by=c("Plot","Treatment"))

TrueDamageCopy1<- aggregate(totaldam ~ Nitrogen + Year +Species,       # Aggregate data
                            TrueDamage,FUN=sum) %>%
  rename(Npresence=totaldam)

TrueDamageCopy2<- aggregate(totaldam ~ Potassium + Year + Species,       # Aggregate data
                            TrueDamage,FUN=sum) %>%
  rename(Kpresence=totaldam)

TrueDamageCopy3<- aggregate(totaldam ~ Phosphorous + Year + Species,       # Aggregate data
                            TrueDamage,FUN=sum) %>%
  rename(Phpresence=totaldam)

TrueDamageCopy4<- aggregate(totaldam ~ Drought + Year+ Species,       # Aggregate data
                            TrueDamage,FUN=sum) %>%
  rename(Dpresence=totaldam)

TrueDamageCopy5<-left_join(TrueDamageCopy1, TrueDamageCopy2)
TrueDamageCopy6<-left_join(TrueDamageCopy5, TrueDamageCopy3)
TrueDamageCopy<-left_join(TrueDamageCopy6, TrueDamageCopy4)

Yeardam<-as.data.frame(aggregate(TrueDamage["totaldam"],by=TrueDamage["Year"],sum)) %>%
  rename(Yeardamage=totaldam)

TrueDamage1<-left_join(TrueDamage, Yeardam, by="Year")


TrueDam<-left_join(TrueDamage1, TrueDamageCopy, by=c("Year", "Species", "Nitrogen", "Phosphorous","Potassium","Drought")) %>%
  filter(Drought!="D")


TrueDamAristida<-TrueDam %>%
  filter(Species=="Aristida_stricta") %>%
  filter(Drought!="D")

TrueDamPity<-TrueDam %>%
  filter(Species=="Pityopsis_aspera") %>%
  filter(Drought!="D")

TrueDamPteridium<-TrueDam %>%
  filter(Species=="Pteridium_aquilinum") %>%
  filter(Drought!="D")

TrueDamVacc<-TrueDam %>%
  filter(Species=="Vaccinium_tenellum") %>%
  filter(Drought!="D")

TrueDamLiatris<-TrueDam %>%
  filter(Species=="Liatris_cokeri") %>%
  filter(Drought!="D")



TrueHDamTest<-lmerTest::lmer(data=TrueDamage, totaldam~Nitrogen*Phosphorous*Potassium*Year*Species+ (1|Block))
TrueHDamTest
anova(TrueHDamTest, type=3)

TrueHDamDroughtTest<-lmerTest::lmer(data=TrueDamage, totaldam~Nitrogen*Phosphorous*Potassium*Drought*Year*Species+ (1|Block))
TrueHDamDroughtTest
anova(TrueHDamDroughtTest, type=3)



#####TRUE DAM SPECIES GRAPHS ####


#####NITROGEN ESA GRAPHS#####

NYears<-ggplot(data=TrueDam, aes(x=Year, y=Npresence, color=Nitrogen, group=2)) +
  geom_point() + labs(title="Herbivory in the presence of N")
NYears
NYAristida<-ggplot(data=TrueDamAristida, aes(x=Year, y=Npresence, color=Nitrogen, group=2)) +
  geom_point() + labs(title="Herbivory of Aristida stricta in the presence of N")
NYAristida

NYPityopsis<-ggplot(data=TrueDamPity, aes(x=Year, y=Npresence, color=Nitrogen, group=2)) +
  geom_point() + labs(title="Herbivory of Pityopsis aspera in the presence of N")
NYPityopsis

NYPteridium<-ggplot(data=TrueDamPteridium, aes(x=Year, y=Npresence, color=Nitrogen, group=2)) +
  geom_point() + labs(title="Herbivory of Pteridium aquilinum in the presence of N")
NYPteridium

NYVacc<-ggplot(data=TrueDamVacc, aes(x=Year, y=Npresence, color=Nitrogen, group=2)) +
  geom_point() + labs(title="Herbivory of Vaccinium tenellum in the presence of N")
NYVacc

NYLiatris<-ggplot(data=TrueDamLiatris, aes(x=Year, y=Npresence, color=Nitrogen, group=2)) +
  geom_point() + labs(title="Herbivory of Liatris cokeri in the presence of N")
NYLiatris

#####Phosphorous ESA Graphs ####

PhYears<-ggplot(data=TrueDam, aes(x=Year, y=Phpresence, color=Phosphorous, group=2)) +
  geom_point() + labs(title="Herbivory in the presence of P")
PhYears

PhAristida<-ggplot(data=TrueDamAristida, aes(x=Year, y=Phpresence, color=Phosphorous, group=2)) +
  geom_point() + labs(title="Herbivory of Aristida stricta in the presence of P")
PhAristida

PhPityopsis<-ggplot(data=TrueDamPity, aes(x=Year, y=Phpresence, color=Phosphorous, group=2)) +
  geom_point() + labs(title="Herbivory of Pityopsis aspera in the presence of P")
PhPityopsis

PhPteridium<-ggplot(data=TrueDamPteridium, aes(x=Year, y=Phpresence, color=Phosphorous, group=2)) +
  geom_point() + labs(title="Herbivory of Pteridium aquilinum in the presence of P")
PhPteridium

PhVacc<-ggplot(data=TrueDamVacc, aes(x=Year, y=Phpresence, color=Phosphorous, group=2)) +
  geom_point() + labs(title="Herbivory of Vaccinium tenellum in the presence of P")
PhVacc

PhLiatris<-ggplot(data=TrueDamLiatris, aes(x=Year, y=Phpresence, color=Phosphorous, group=2)) +
  geom_point() + labs(title="Herbivory of Liatris cokeri in the presence of P")
PhLiatris


#####Potassium ESA Graphs####

KYears<-ggplot(data=TrueDam, aes(x=Year, y=Kpresence, color=Potassium, group=2)) +
  geom_point() + labs(title="Herbivory in the presence of K")
KYears
KAristida<-ggplot(data=TrueDamAristida, aes(x=Year, y=Kpresence, color=Potassium, group=2)) +
  geom_point() + labs(title="Herbivory of Aristida stricta in the presence of K")
KAristida

KPityopsis<-ggplot(data=TrueDamPity, aes(x=Year, y=Kpresence, color=Potassium, group=2)) +
  geom_point() + labs(title="Herbivory of Pityopsis aspera in the presence of K")
KPityopsis

KPteridium<-ggplot(data=TrueDamPteridium, aes(x=Year, y=Kpresence, color=Potassium, group=2)) +
  geom_point() + labs(title="Herbivory of Pteridium aquilinum in the presence of K")
KPteridium

KVacc<-ggplot(data=TrueDamVacc, aes(x=Year, y=Kpresence, color=Potassium, group=2)) +
  geom_point() + labs(title="Herbivory of Vaccinium tenellum in the presence of K")
KVacc

KLiatris<-ggplot(data=TrueDamLiatris, aes(x=Year, y=Kpresence, color=Potassium, group=2)) +
  geom_point() + labs(title="Herbivory of Liatris cokeri in the presence of K")
KLiatris
